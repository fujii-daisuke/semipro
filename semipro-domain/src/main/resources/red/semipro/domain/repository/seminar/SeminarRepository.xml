<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="red.semipro.domain.repository.seminar.SeminarRepository">

    <sql id="baseSelectPhrase">
        SELECT
            id
            , opening_status
            , seminar_type
            , minimum_number
            , capacity
            , entry_ending_at
            , success_condition
            , seminar_starting_at
            , seminar_ending_at
            , account_id
    </sql>
    <select id="findOne" resultMap="resultMap">
        <include refid="baseSelectPhrase"/>
        FROM
        seminar
        WHERE
        id = #{id}
    </select>

    <select id="findOneBy" resultMap="resultMap">
        <include refid="baseSelectPhrase"/>
        FROM
        seminar
        WHERE
        id = #{id}
        <if test="accountId != null">
            AND account_id = #{accountId}
        </if>
        <if test="openingStatus != null">
            AND opening_status = #{openingStatus.value}
        </if>
    </select>

    <resultMap id="resultMap" type="red.semipro.domain.model.Seminar">
        <id property="id" column="id"/>
        <result property="openingStatus" column="opening_status"/>
        <result property="seminarType" column="seminar_type"/>
        <result property="minimumNumber" column="minimum_number"/>
        <result property="capacity" column="capacity"/>
        <result property="entryStartingAt" column="entry_starting_at"/>
        <result property="entryEndingAt" column="entry_ending_at"/>
        <result property="successCondition" column="success_condition"/>
        <result property="seminarStartingAt" column="seminar_starting_at"/>
        <result property="seminarEndingAt" column="seminar_ending_at"/>
        <result property="account.id" column="account_id"/>
    </resultMap>

    <insert id="initialize" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO seminar (
            opening_status
            , account_id
        ) VALUES (
            #{openingStatus.value}
            , #{account.id}
        )
    </insert>

    <update id="update">
        UPDATE seminar SET
            seminar_type = #{seminarType.value}
            , minimum_number = #{minimumNumber}
            , capacity = #{capacity}
            , entry_ending_at = #{entryEndingAt}
            , success_condition = #{successCondition.value}
            , seminar_starting_at = #{seminarStartingAt}
            , seminar_ending_at = #{seminarEndingAt}
            , updated_at = CURRENT_TIMESTAMP
        WHERE
            id = #{id}
    </update>

    <update id="updateOpeningStatus">
        UPDATE seminar SET
            opening_status = #{openingStatus.value}
            , updated_at = CURRENT_TIMESTAMP
        WHERE
            id = #{seminarId}
    </update>

</mapper>