<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="red.semipro.domain.repository.seminar.SeminarSummaryRepository">

    <select id="countByCriteria" resultType="_long">
        SELECT
        COUNT(*)
        FROM
        seminar
        <include refid="findPageByCriteriaWherePhrase"/>
    </select>

    <select id="findPageByCriteria" resultMap="seminarSummaryResultMap">
        <include refid="baseSelectPhrase"/>
        <include refid="baseFromPhrase"/>
        <include refid="findPageByCriteriaWherePhrase"/>
        ORDER BY
        #{pageable.sort}
        LIMIT
        #{pageable.pageSize}
        OFFSET
        #{pageable.offset}
    </select>

    <sql id="baseSelectPhrase">
        SELECT
            seminar.id
            , seminar.opening_status
            , seminar.seminar_type
            , seminar.minimum_number
            , seminar.capacity
            , seminar.entry_starting_at
            , seminar.entry_ending_at
            , seminar.success_condition
            , seminar.seminar_starting_at
            , seminar.seminar_ending_at
            , seminar_overview.title
            , seminar_overview.summary
            , seminar_place.place_arrangement
            , prefecture.id prefecture_id
            , prefecture.name prefecture_name
            , city.id city_id
            , city.name city_name
            , seminar_place.address
            , seminar_place.place
            , seminar_entry_summary.entry_count
    </sql>

    <sql id="baseFromPhrase">
        FROM seminar
        INNER JOIN seminar_overview ON seminar.id = seminar_overview.seminar_id
        LEFT OUTER JOIN seminar_place ON seminar.id = seminar_place.seminar_id
        LEFT OUTER JOIN prefecture ON seminar_place.prefecture_id = prefecture.id
        LEFT OUTER JOIN city ON prefecture.id = city.prefecture_id AND seminar_place.city_id = city.id
        LEFT OUTER JOIN seminar_entry_summary ON seminar.id = seminar_entry_summary.seminar_id
    </sql>

    <sql id="findPageByCriteriaWherePhrase">
        <where>
            <if test="criteria.beforeEntryEndingAt">
                CURRENT_TIMESTAMP <![CDATA[ <= ]]> seminar.entry_ending_at
            </if>
            <if test="criteria.openingStatus != null">
                AND opening_status = #{criteria.openingStatus.value}
            </if>
            <if test="criteria.accountId != null">
                AND account_id = #{criteria.accountId}
            </if>
        </where>
    </sql>

    <resultMap id="seminarSummaryResultMap" type="red.semipro.domain.model.seminar.SeminarSummary">
        <association property="seminar" javaType="red.semipro.domain.model.Seminar">
            <id property="id" column="id"/>
            <result property="openingStatus" column="opening_status"/>
            <result property="seminarType" column="seminar_type"/>
            <result property="minimumNumber" column="minimum_number"/>
            <result property="capacity" column="capacity"/>
            <result property="entryStartingAt" column="entry_starting_at"/>
            <result property="entryEndingAt" column="entry_ending_at"/>
            <result property="successCondition" column="success_condition"/>
            <result property="seminarStartingAt" column="seminar_starting_at"/>
            <result property="seminarEndingAt" column="seminar_ending_at"/>
        </association>
        <association property="overview" javaType="red.semipro.domain.model.seminar.SeminarOverview">
            <id property="seminarId" column="id"/>
            <result property="title" column="title"/>
            <result property="summary" column="summary"/>
        </association>
        <association property="place" javaType="red.semipro.domain.model.seminar.SeminarPlace">
            <id property="seminarId" column="id"/>
            <result property="placeArrangement" column="place_arrangement"/>
            <result property="prefecture.id" column="prefecture_id"/>
            <result property="prefecture.name" column="prefecture_name"/>
            <result property="city.id" column="city_id"/>
            <result property="city.name" column="city_name"/>
            <result property="address" column="address"/>
            <result property="place" column="place"/>
        </association>
        <association property="entrySummary" javaType="red.semipro.domain.model.seminar.SeminarEntrySummary">
            <id property="seminarId" column="id"/>
            <result property="entryCount" column="entry_count"/>
        </association>
    </resultMap>

</mapper>